"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deleteficheTN = exports.updateFicheTN = exports.addFicheTN = exports.getFicheTNByEmployee = exports.getAllfichesTN = exports.deleteficheFR = exports.updateFicheFR = exports.addFicheFR = exports.getFicheFRByEmployee = exports.getAllfichesFR = void 0;
const user_model_1 = require("../models/user.model");
const fichePaix_model_1 = require("../models/fichePaix.model");
const fichePaix_model_2 = require("../models/fichePaix.model");
const champFacture_model_1 = require("../models/champFacture.model");
const getAllfichesFR = async (req, res) => {
    try {
        const fiches = await fichePaix_model_1.FicheFR.find().sort('dateDebut').exec();
        return res.send(fiches);
    }
    catch (err) {
        res.send('no fiches yet');
    }
};
exports.getAllfichesFR = getAllfichesFR;
const getFicheFRByEmployee = async (req, res) => {
    const employee = await user_model_1.User.findOne({ email: req.params.email });
    if (employee) {
        try {
            const fiches = await fichePaix_model_1.FicheFR.find({ beneficiaire: employee }).sort('dateDebut').exec();
            return res.send(fiches);
        }
        catch (err) {
            res.send('no fiches yet');
        }
    }
    else {
        res.send('no employee with such email');
    }
};
exports.getFicheFRByEmployee = getFicheFRByEmployee;
const addFicheFR = async (req, res) => {
    var _a;
    const beneficiaire = await user_model_1.User.findOne({ email: req.body.email });
    const fiches = await fichePaix_model_1.FicheFR.find();
    let exist = false;
    const { dateDebut, dateFin, postOccupe, matricule, numSecuriteSocial, netPaye, email } = req.body;
    if (beneficiaire) {
        fiches.forEach(function (fiche) {
            if (String(fiche.dateDebut) == String(new Date(dateDebut)) &&
                String(fiche.dateFin) == String(new Date(dateFin)) &&
                String(fiche.beneficiaire) == String(beneficiaire._id)) {
                exist = true;
            }
        });
        if (!exist) {
            const ficheFr = new fichePaix_model_1.FicheFR({
                dateDebut: new Date(dateDebut),
                dateFin: new Date(dateFin),
                postOccupe: postOccupe,
                matricule: matricule,
                numSecuriteSocial: numSecuriteSocial,
                netPaye: netPaye,
                beneficiaire: beneficiaire,
            });
            ficheFr.populate('beneficiaire');
            try {
                const savedFicheFr = await ficheFr.save();
                (_a = beneficiaire.ficheDePaixFR) === null || _a === void 0 ? void 0 : _a.push(savedFicheFr);
                beneficiaire.save();
                res.send(savedFicheFr);
            }
            catch (err) {
                res.status(400).send('il y a une erreur');
            }
        }
        else {
            res.status(400).send('fiche déjà existante');
        }
    }
    else {
        res.status(400).send('pas d employe avec cette adresse email');
    }
};
exports.addFicheFR = addFicheFR;
const updateFicheFR = async (req, res) => {
    var _a;
    const fiche = await fichePaix_model_1.FicheFR.findOne({ _id: req.params.id });
    const { dateDebut, dateFin, postOccupe, matricule, numSecuriteSocial, netPaye } = req.body;
    if (fiche) {
        const beneficiaire = await user_model_1.User.findOne({ _id: fiche.beneficiaire._id });
        fichePaix_model_1.FicheFR.updateOne({ _id: fiche._id }, {
            dateDebut: new Date(dateDebut),
            dateFin: new Date(dateFin),
            postOccupe: postOccupe,
            matricule: matricule,
            numSecuriteSocial: numSecuriteSocial,
            netPaye: netPaye,
        }, function (err, data) {
            if (err) {
                return res.status(400).send('erreur');
            }
            else {
                return res.status(200).send('fiche updated successfully');
            }
        });
        try {
            await fiche.save();
            if (beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixFR) {
                const index = beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixFR.indexOf(fiche);
                if (index) {
                    if (!(beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixFR[index])) {
                        await ((_a = beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixFR) === null || _a === void 0 ? void 0 : _a.push(fiche));
                        await (beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.save());
                    }
                }
            }
        }
        catch (err) {
            res.status(400);
        }
    }
    else {
        return res.status(400).send('email introuvable');
    }
};
exports.updateFicheFR = updateFicheFR;
const deleteficheFR = async (req, res) => {
    var _a, _b;
    const fiche = await fichePaix_model_1.FicheFR.findOne({ _id: req.params.id });
    if (fiche) {
        await fichePaix_model_1.FicheFR.deleteOne({ _id: fiche._id });
        if (fiche.ChampFiche) {
            fiche.ChampFiche.forEach(async (champ) => {
                await champFacture_model_1.Champ.deleteOne({ _id: champ });
            });
        }
        const user = await user_model_1.User.findOne({ _id: fiche.beneficiaire._id });
        const id = fiche._id;
        const ind = (_a = user === null || user === void 0 ? void 0 : user.ficheDePaixFR) === null || _a === void 0 ? void 0 : _a.indexOf(fiche);
        if (ind) {
            (_b = user === null || user === void 0 ? void 0 : user.ficheDePaixFR) === null || _b === void 0 ? void 0 : _b.splice(ind, 1);
            user === null || user === void 0 ? void 0 : user.save();
        }
        return res.status(200).send('fiche deleted');
    }
    else {
        return res.status(404).send('no fiche with id: ' + req.params.id);
    }
};
exports.deleteficheFR = deleteficheFR;
const getAllfichesTN = async (req, res) => {
    try {
        const fiches = await fichePaix_model_2.FicheTN.find().sort('dateDebut').exec();
        return res.send(fiches);
    }
    catch (err) {
        res.send('no fiches yet');
    }
};
exports.getAllfichesTN = getAllfichesTN;
const getFicheTNByEmployee = async (req, res) => {
    const employee = await user_model_1.User.findOne({ email: req.params.email });
    if (employee) {
        try {
            const fiches = await fichePaix_model_2.FicheTN.find({ beneficiaire: employee }).sort('dateDebut').exec();
            return res.send(fiches);
        }
        catch (err) {
            res.send('no fiches yet');
        }
    }
    else {
        res.send('no employee with such email');
    }
};
exports.getFicheTNByEmployee = getFicheTNByEmployee;
const addFicheTN = async (req, res) => {
    var _a;
    const beneficiaire = await user_model_1.User.findOne({ email: req.body.email });
    const fiches = await fichePaix_model_2.FicheTN.find();
    let exist = false;
    const { dateDebut, dateFin, postOccupe, matricule, numSecuriteSocial, netPaye, email } = req.body;
    if (beneficiaire) {
        fiches.forEach(function (fiche) {
            if (String(fiche.dateDebut) == String(new Date(dateDebut)) &&
                String(fiche.dateFin) == String(new Date(dateFin)) &&
                String(fiche.beneficiaire) == String(beneficiaire._id)) {
                exist = true;
            }
        });
        if (!exist) {
            const ficheTn = new fichePaix_model_2.FicheTN({
                dateDebut: new Date(dateDebut),
                dateFin: new Date(dateFin),
                postOccupe: postOccupe,
                matricule: matricule,
                numSecuriteSocial: numSecuriteSocial,
                netPaye: netPaye,
                beneficiaire: beneficiaire,
            });
            ficheTn.populate('beneficiaire');
            try {
                const savedFicheTn = await ficheTn.save();
                (_a = beneficiaire.ficheDePaixTN) === null || _a === void 0 ? void 0 : _a.push(savedFicheTn);
                beneficiaire.save();
                res.send(savedFicheTn);
            }
            catch (err) {
                res.status(400).send('il y a une erreur');
            }
        }
        else {
            res.status(400).send('fiche déjà existante');
        }
    }
    else {
        res.status(400).send('pas d employe avec cette adresse email');
    }
};
exports.addFicheTN = addFicheTN;
const updateFicheTN = async (req, res) => {
    var _a;
    const fiche = await fichePaix_model_2.FicheTN.findOne({ _id: req.params.id });
    const { dateDebut, dateFin, postOccupe, matricule, numSecuriteSocial, netPaye } = req.body;
    if (fiche) {
        const beneficiaire = await user_model_1.User.findOne({ _id: fiche.beneficiaire._id });
        console.log(fiche);
        fichePaix_model_2.FicheTN.updateOne({ _id: fiche._id }, {
            dateDebut: new Date(dateDebut),
            dateFin: new Date(dateFin),
            postOccupe: postOccupe,
            matricule: matricule,
            numSecuriteSocial: numSecuriteSocial,
            netPaye: netPaye,
        }, function (err, data) {
            if (err) {
                return res.status(400).send('erreur');
            }
            else {
                return res.status(200).send('fiche updated successfully');
            }
        });
        try {
            await fiche.save();
            if (beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixTN) {
                const index = beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixTN.indexOf(fiche);
                if (index) {
                    if (!(beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixTN[index])) {
                        await ((_a = beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.ficheDePaixTN) === null || _a === void 0 ? void 0 : _a.push(fiche));
                        await (beneficiaire === null || beneficiaire === void 0 ? void 0 : beneficiaire.save());
                    }
                }
            }
        }
        catch (err) {
            res.status(400);
        }
    }
    else {
        return res.status(400).send('email introuvable');
    }
};
exports.updateFicheTN = updateFicheTN;
const deleteficheTN = async (req, res) => {
    var _a, _b;
    const fiche = await fichePaix_model_2.FicheTN.findOne({ _id: req.params.id });
    if (fiche) {
        await fichePaix_model_2.FicheTN.deleteOne({ _id: fiche._id });
        if (fiche.ChampFiche) {
            fiche.ChampFiche.forEach(async (champ) => {
                await champFacture_model_1.Champ.deleteOne({ _id: champ });
            });
        }
        const user = await user_model_1.User.findOne({ _id: fiche.beneficiaire._id });
        const id = fiche._id;
        const ind = (_a = user === null || user === void 0 ? void 0 : user.ficheDePaixTN) === null || _a === void 0 ? void 0 : _a.indexOf(fiche);
        if (ind) {
            (_b = user === null || user === void 0 ? void 0 : user.ficheDePaixTN) === null || _b === void 0 ? void 0 : _b.splice(ind, 1);
            user === null || user === void 0 ? void 0 : user.save();
        }
        return res.status(200).send('fiche deleted');
    }
    else {
        return res.status(404).send('no fiche with id: ' + req.params.id);
    }
};
exports.deleteficheTN = deleteficheTN;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmljaGVEZVBhaXguY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIuL3NyYy8iLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2ZpY2hlRGVQYWl4LmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscURBQTRDO0FBQzVDLCtEQUFvRDtBQUNwRCwrREFBb0Q7QUFDcEQscUVBQXFEO0FBSTlDLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDL0MsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLE1BQU0seUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0QsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ3pCO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0tBQzNCO0FBQ0gsQ0FBQyxDQUFDO0FBUFcsUUFBQSxjQUFjLGtCQU96QjtBQUVLLE1BQU0sb0JBQW9CLEdBQUcsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUNyRCxNQUFNLFFBQVEsR0FBRyxNQUFNLGlCQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUMvRCxJQUFJLFFBQVEsRUFBRTtRQUNaLElBQUk7WUFDSixNQUFNLE1BQU0sR0FBRyxNQUFNLHlCQUFPLENBQUMsSUFBSSxDQUFDLEVBQUMsWUFBWSxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3JGLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN6QjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1os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LENBQUM7U0FDZDtRQUVELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7S0FDOUM7U0FBTTtRQUNMLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNuRTtBQUNILENBQUMsQ0FBQztBQXJCVyxRQUFBLGFBQWEsaUJBcUJ4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9tb2RlbHMvdXNlci5tb2RlbCc7XG5pbXBvcnQgeyBGaWNoZUZSIH0gZnJvbSAnLi4vbW9kZWxzL2ZpY2hlUGFpeC5tb2RlbCc7XG5pbXBvcnQgeyBGaWNoZVROIH0gZnJvbSAnLi4vbW9kZWxzL2ZpY2hlUGFpeC5tb2RlbCc7XG5pbXBvcnQgeyBDaGFtcCB9IGZyb20gJy4uL21vZGVscy9jaGFtcEZhY3R1cmUubW9kZWwnO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuXG4vL2dldCBhbGwgZmljaGVzIEZSXG5leHBvcnQgY29uc3QgZ2V0QWxsZmljaGVzRlIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBmaWNoZXMgPSBhd2FpdCBGaWNoZUZSLmZpbmQoKS5zb3J0KCdkYXRlRGVidXQnKS5leGVjKCk7XG4gICAgcmV0dXJuIHJlcy5zZW5kKGZpY2hlcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKCdubyBmaWNoZXMgeWV0Jyk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBnZXRGaWNoZUZSQnlFbXBsb3llZSA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBlbXBsb3llZSA9IGF3YWl0IFVzZXIuZmluZE9uZSh7ZW1haWw6IHJlcS5wYXJhbXMuZW1haWx9KTtcbiAgaWYgKGVtcGxveWVlKSB7XG4gICAgdHJ5IHtcbiAgICBjb25zdCBmaWNoZXMgPSBhd2FpdCBGaWNoZUZSLmZpbmQoe2JlbmVmaWNpYWlyZTogZW1wbG95ZWV9KS5zb3J0KCdkYXRlRGVidXQnKS5leGVjKCk7XG4gICAgcmV0dXJuIHJlcy5zZW5kKGZpY2hlcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKCdubyBmaWNoZXMgeWV0Jyk7XG4gIH19IGVsc2Uge1xuICAgIHJlcy5zZW5kKCdubyBlbXBsb3llZSB3aXRoIHN1Y2ggZW1haWwnKTtcbiAgfVxufTtcblxuXG4vL2FkZCBmaWNoZUZSXG5leHBvcnQgY29uc3QgYWRkRmljaGVGUiA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcbiAgY29uc3QgYmVuZWZpY2lhaXJlID0gYXdhaXQgVXNlci5maW5kT25lKHsgZW1haWw6IHJlcS5ib2R5LmVtYWlsIH0pO1xuICBjb25zdCBmaWNoZXMgPSBhd2FpdCBGaWNoZUZSLmZpbmQoKTtcbiAgbGV0IGV4aXN0ID0gZmFsc2U7XG4gIGNvbnN0IHsgZGF0ZURlYnV0LCBkYXRlRmluLCBwb3N0T2NjdXBlLCBtYXRyaWN1bGUsIG51bVNlY3VyaXRlU29jaWFsLCBuZXRQYXllLCBlbWFpbCB9ID0gcmVxLmJvZHk7XG4gIGlmIChiZW5lZmljaWFpcmUpIHtcbiAgICBmaWNoZXMuZm9yRWFjaChmdW5jdGlvbiAoZmljaGUpIHtcbiAgICAgIGlmIChcbiAgICAgICAgU3RyaW5nKGZpY2hlLmRhdGVEZWJ1dCkgPT0gU3RyaW5nKG5ldyBEYXRlKGRhdGVEZWJ1dCkpICYmXG4gICAgICAgIFN0cmluZyhmaWNoZS5kYXRlRmluKSA9PSBTdHJpbmcobmV3IERhdGUoZGF0ZUZpbikpICYmXG4gICAgICAgIFN0cmluZyhmaWNoZS5iZW5lZmljaWFpcmUpID09IFN0cmluZyhiZW5lZmljaWFpcmUuX2lkKVxuICAgICAgKSB7XG4gICAgICAgIGV4aXN0ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoIWV4aXN0KSB7XG4gICAgICBjb25zdCBmaWNoZUZyID0gbmV3IEZpY2hlRlIoe1xuICAgICAgICBkYXRlRGVidXQ6IG5ldyBEYXRlKGRhdGVEZWJ1dCksXG4gICAgICAgIGRhdGVGaW46IG5ldyBEYXRlKGRhdGVGaW4pLFxuICAgICAgICBwb3N0T2NjdXBlOiBwb3N0T2NjdXBlLFxuICAgICAgICBtYXRyaWN1bGU6IG1hdHJpY3VsZSxcbiAgICAgICAgbnVtU2VjdXJpdGVTb2NpYWw6IG51bVNlY3VyaXRlU29jaWFsLFxuICAgICAgICBuZXRQYXllOiBuZXRQYXllLFxuICAgICAgICBiZW5lZmljaWFpcmU6IGJlbmVmaWNpYWlyZSxcbiAgICAgIH0pO1xuICAgICAgZmljaGVGci5wb3B1bGF0ZSgnYmVuZWZpY2lhaXJlJyk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzYXZlZEZpY2hlRnIgPSBhd2FpdCBmaWNoZUZyLnNhdmUoKTtcbiAgICAgICAgYmVuZWZpY2lhaXJlLmZpY2hlRGVQYWl4RlI/LnB1c2goc2F2ZWRGaWNoZUZyKTtcbiAgICAgICAgYmVuZWZpY2lhaXJlLnNhdmUoKTtcbiAgICAgICAgcmVzLnNlbmQoc2F2ZWRGaWNoZUZyKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuc2VuZCgnaWwgeSBhIHVuZSBlcnJldXInKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmVzLnN0YXR1cyg0MDApLnNlbmQoJ2ZpY2hlIGTDqWrDoCBleGlzdGFudGUnKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmVzLnN0YXR1cyg0MDApLnNlbmQoJ3BhcyBkIGVtcGxveWUgYXZlYyBjZXR0ZSBhZHJlc3NlIGVtYWlsJyk7XG4gIH1cbn07XG5cbi8vdXBkYXRlIGZpY2hlRlJcbmV4cG9ydCBjb25zdCB1cGRhdGVGaWNoZUZSID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGZpY2hlID0gYXdhaXQgRmljaGVGUi5maW5kT25lKHsgX2lkOiByZXEucGFyYW1zLmlkIH0pO1xuICBjb25zdCB7IGRhdGVEZWJ1dCwgZGF0ZUZpbiwgcG9zdE9jY3VwZSwgbWF0cmljdWxlLCBudW1TZWN1cml0ZVNvY2lhbCwgbmV0UGF5ZSB9ID0gcmVxLmJvZHk7XG4gIGlmIChmaWNoZSkge1xuICAgIGNvbnN0IGJlbmVmaWNpYWlyZSA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IF9pZDogZmljaGUuYmVuZWZpY2lhaXJlLl9pZCB9KTtcbiAgICBGaWNoZUZSLnVwZGF0ZU9uZShcbiAgICAgIHsgX2lkOiBmaWNoZS5faWQgfSxcbiAgICAgIHtcbiAgICAgICAgZGF0ZURlYnV0OiBuZXcgRGF0ZShkYXRlRGVidXQpLFxuICAgICAgICBkYXRlRmluOiBuZXcgRGF0ZShkYXRlRmluKSxcbiAgICAgICAgcG9zdE9jY3VwZTogcG9zdE9jY3VwZSxcbiAgICAgICAgbWF0cmljdWxlOiBtYXRyaWN1bGUsXG4gICAgICAgIG51bVNlY3VyaXRlU29jaWFsOiBudW1TZWN1cml0ZVNvY2lhbCxcbiAgICAgICAgbmV0UGF5ZTogbmV0UGF5ZSxcbiAgICAgIH0sXG4gICAgICBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoJ2VycmV1cicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCgnZmljaGUgdXBkYXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZpY2hlLnNhdmUoKTtcbiAgICAgIGlmIChiZW5lZmljaWFpcmU/LmZpY2hlRGVQYWl4RlIpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBiZW5lZmljaWFpcmU/LmZpY2hlRGVQYWl4RlIuaW5kZXhPZihmaWNoZSk7XG4gICAgICAgIGlmIChpbmRleCkge1xuICAgICAgICAgIGlmICghYmVuZWZpY2lhaXJlPy5maWNoZURlUGFpeEZSW2luZGV4XSkge1xuICAgICAgICAgICAgYXdhaXQgYmVuZWZpY2lhaXJlPy5maWNoZURlUGFpeEZSPy5wdXNoKGZpY2hlKTtcbiAgICAgICAgICAgIGF3YWl0IGJlbmVmaWNpYWlyZT8uc2F2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy9yZXMuc2VuZChzYXZlZGZpY2hlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdlbWFpbCBpbnRyb3V2YWJsZScpO1xuICB9XG59O1xuXG4vL2RlbGV0ZSBmaWNoZUZSXG5leHBvcnQgY29uc3QgZGVsZXRlZmljaGVGUiA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBmaWNoZSA9IGF3YWl0IEZpY2hlRlIuZmluZE9uZSh7IF9pZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgaWYgKGZpY2hlKSB7XG4gICAgYXdhaXQgRmljaGVGUi5kZWxldGVPbmUoeyBfaWQ6IGZpY2hlLl9pZCB9KTtcbiAgICBpZiAoZmljaGUuQ2hhbXBGaWNoZSkge1xuICAgICAgZmljaGUuQ2hhbXBGaWNoZS5mb3JFYWNoKGFzeW5jIChjaGFtcCkgPT4ge1xuICAgICAgICBhd2FpdCBDaGFtcC5kZWxldGVPbmUoeyBfaWQ6IGNoYW1wIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyBfaWQ6IGZpY2hlLmJlbmVmaWNpYWlyZS5faWQgfSk7XG4gICAgY29uc3QgaWQgPSBmaWNoZS5faWQ7XG4gICAgY29uc3QgaW5kID0gdXNlcj8uZmljaGVEZVBhaXhGUj8uaW5kZXhPZihmaWNoZSk7XG4gICAgaWYgKGluZCkge1xuICAgICAgdXNlcj8uZmljaGVEZVBhaXhGUj8uc3BsaWNlKGluZCwgMSk7XG4gICAgICB1c2VyPy5zYXZlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCdmaWNoZSBkZWxldGVkJyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5zZW5kKCdubyBmaWNoZSB3aXRoIGlkOiAnICsgcmVxLnBhcmFtcy5pZCk7XG4gIH1cbn07XG5cbi8vZ2V0IGFsbCBmaWNoZXMgVE5cbmV4cG9ydCBjb25zdCBnZXRBbGxmaWNoZXNUTiA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGZpY2hlcyA9IGF3YWl0IEZpY2hlVE4uZmluZCgpLnNvcnQoJ2RhdGVEZWJ1dCcpLmV4ZWMoKTtcbiAgICByZXR1cm4gcmVzLnNlbmQoZmljaGVzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoJ25vIGZpY2hlcyB5ZXQnKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGdldEZpY2hlVE5CeUVtcGxveWVlID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGVtcGxveWVlID0gYXdhaXQgVXNlci5maW5kT25lKHtlbWFpbDogcmVxLnBhcmFtcy5lbWFpbH0pO1xuICBpZiAoZW1wbG95ZWUpIHtcbiAgICB0cnkge1xuICAgIGNvbnN0IGZpY2hlcyA9IGF3YWl0IEZpY2hlVE4uZmluZCh7YmVuZWZpY2lhaXJlOiBlbXBsb3llZX0pLnNvcnQoJ2RhdGVEZWJ1dCcpLmV4ZWMoKTtcbiAgICByZXR1cm4gcmVzLnNlbmQoZmljaGVzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnNlbmQoJ25vIGZpY2hlcyB5ZXQnKTtcbiAgfX0gZWxzZSB7XG4gICAgcmVzLnNlbmQoJ25vIGVtcGxveWVlIHdpdGggc3VjaCBlbWFpbCcpO1xuICB9XG59O1xuLy9hZGQgRmljaGVUTlxuZXhwb3J0IGNvbnN0IGFkZEZpY2hlVE4gPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IGJlbmVmaWNpYWlyZSA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiByZXEuYm9keS5lbWFpbCB9KTtcbiAgY29uc3QgZmljaGVzID0gYXdhaXQgRmljaGVUTi5maW5kKCk7XG4gIGxldCBleGlzdCA9IGZhbHNlO1xuICBjb25zdCB7IGRhdGVEZWJ1dCwgZGF0ZUZpbiwgcG9zdE9jY3VwZSwgbWF0cmljdWxlLCBudW1TZWN1cml0ZVNvY2lhbCwgbmV0UGF5ZSwgZW1haWwgfSA9IHJlcS5ib2R5O1xuICBpZiAoYmVuZWZpY2lhaXJlKSB7XG4gICAgZmljaGVzLmZvckVhY2goZnVuY3Rpb24gKGZpY2hlKSB7XG4gICAgICBpZiAoXG4gICAgICAgIFN0cmluZyhmaWNoZS5kYXRlRGVidXQpID09IFN0cmluZyhuZXcgRGF0ZShkYXRlRGVidXQpKSAmJlxuICAgICAgICBTdHJpbmcoZmljaGUuZGF0ZUZpbikgPT0gU3RyaW5nKG5ldyBEYXRlKGRhdGVGaW4pKSAmJlxuICAgICAgICBTdHJpbmcoZmljaGUuYmVuZWZpY2lhaXJlKSA9PSBTdHJpbmcoYmVuZWZpY2lhaXJlLl9pZClcbiAgICAgICkge1xuICAgICAgICBleGlzdCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKCFleGlzdCkge1xuICAgICAgY29uc3QgZmljaGVUbiA9IG5ldyBGaWNoZVROKHtcbiAgICAgICAgZGF0ZURlYnV0OiBuZXcgRGF0ZShkYXRlRGVidXQpLFxuICAgICAgICBkYXRlRmluOiBuZXcgRGF0ZShkYXRlRmluKSxcbiAgICAgICAgcG9zdE9jY3VwZTogcG9zdE9jY3VwZSxcbiAgICAgICAgbWF0cmljdWxlOiBtYXRyaWN1bGUsXG4gICAgICAgIG51bVNlY3VyaXRlU29jaWFsOiBudW1TZWN1cml0ZVNvY2lhbCxcbiAgICAgICAgbmV0UGF5ZTogbmV0UGF5ZSxcbiAgICAgICAgYmVuZWZpY2lhaXJlOiBiZW5lZmljaWFpcmUsXG4gICAgICB9KTtcbiAgICAgIGZpY2hlVG4ucG9wdWxhdGUoJ2JlbmVmaWNpYWlyZScpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qgc2F2ZWRGaWNoZVRuID0gYXdhaXQgZmljaGVUbi5zYXZlKCk7XG4gICAgICAgIGJlbmVmaWNpYWlyZS5maWNoZURlUGFpeFROPy5wdXNoKHNhdmVkRmljaGVUbik7XG4gICAgICAgIGJlbmVmaWNpYWlyZS5zYXZlKCk7XG4gICAgICAgIHJlcy5zZW5kKHNhdmVkRmljaGVUbik7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLnNlbmQoJ2lsIHkgYSB1bmUgZXJyZXVyJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdmaWNoZSBkw6lqw6AgZXhpc3RhbnRlJyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdwYXMgZCBlbXBsb3llIGF2ZWMgY2V0dGUgYWRyZXNzZSBlbWFpbCcpO1xuICB9XG59O1xuXG4vL3VwZGF0ZSBmaWNoZVROXG5leHBvcnQgY29uc3QgdXBkYXRlRmljaGVUTiA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBmaWNoZSA9IGF3YWl0IEZpY2hlVE4uZmluZE9uZSh7IF9pZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgY29uc3QgeyBkYXRlRGVidXQsIGRhdGVGaW4sIHBvc3RPY2N1cGUsIG1hdHJpY3VsZSwgbnVtU2VjdXJpdGVTb2NpYWwsIG5ldFBheWUgfSA9IHJlcS5ib2R5O1xuICBpZiAoZmljaGUpIHtcbiAgICBjb25zdCBiZW5lZmljaWFpcmUgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyBfaWQ6IGZpY2hlLmJlbmVmaWNpYWlyZS5faWQgfSk7XG4gICAgY29uc29sZS5sb2coZmljaGUpO1xuICAgIEZpY2hlVE4udXBkYXRlT25lKFxuICAgICAgeyBfaWQ6IGZpY2hlLl9pZCB9LFxuICAgICAge1xuICAgICAgICBkYXRlRGVidXQ6IG5ldyBEYXRlKGRhdGVEZWJ1dCksXG4gICAgICAgIGRhdGVGaW46IG5ldyBEYXRlKGRhdGVGaW4pLFxuICAgICAgICBwb3N0T2NjdXBlOiBwb3N0T2NjdXBlLFxuICAgICAgICBtYXRyaWN1bGU6IG1hdHJpY3VsZSxcbiAgICAgICAgbnVtU2VjdXJpdGVTb2NpYWw6IG51bVNlY3VyaXRlU29jaWFsLFxuICAgICAgICBuZXRQYXllOiBuZXRQYXllLFxuICAgICAgfSxcbiAgICAgIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnZXJyZXVyJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCdmaWNoZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgZmljaGUuc2F2ZSgpO1xuICAgICAgaWYgKGJlbmVmaWNpYWlyZT8uZmljaGVEZVBhaXhUTikge1xuICAgICAgICBjb25zdCBpbmRleCA9IGJlbmVmaWNpYWlyZT8uZmljaGVEZVBhaXhUTi5pbmRleE9mKGZpY2hlKTtcbiAgICAgICAgaWYgKGluZGV4KSB7XG4gICAgICAgICAgaWYgKCFiZW5lZmljaWFpcmU/LmZpY2hlRGVQYWl4VE5baW5kZXhdKSB7XG4gICAgICAgICAgICBhd2FpdCBiZW5lZmljaWFpcmU/LmZpY2hlRGVQYWl4VE4/LnB1c2goZmljaGUpO1xuICAgICAgICAgICAgYXdhaXQgYmVuZWZpY2lhaXJlPy5zYXZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvL3Jlcy5zZW5kKHNhdmVkZmljaGUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmVzLnN0YXR1cyg0MDApO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoJ2VtYWlsIGludHJvdXZhYmxlJyk7XG4gIH1cbn07XG5cbi8vZGVsZXRlIGZpY2hlVE5cbmV4cG9ydCBjb25zdCBkZWxldGVmaWNoZVROID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGZpY2hlID0gYXdhaXQgRmljaGVUTi5maW5kT25lKHsgX2lkOiByZXEucGFyYW1zLmlkIH0pO1xuICBpZiAoZmljaGUpIHtcbiAgICBhd2FpdCBGaWNoZVROLmRlbGV0ZU9uZSh7IF9pZDogZmljaGUuX2lkIH0pO1xuICAgIGlmIChmaWNoZS5DaGFtcEZpY2hlKSB7XG4gICAgICBmaWNoZS5DaGFtcEZpY2hlLmZvckVhY2goYXN5bmMgKGNoYW1wKSA9PiB7XG4gICAgICAgIGF3YWl0IENoYW1wLmRlbGV0ZU9uZSh7IF9pZDogY2hhbXAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IF9pZDogZmljaGUuYmVuZWZpY2lhaXJlLl9pZCB9KTtcbiAgICBjb25zdCBpZCA9IGZpY2hlLl9pZDtcbiAgICBjb25zdCBpbmQgPSB1c2VyPy5maWNoZURlUGFpeFROPy5pbmRleE9mKGZpY2hlKTtcbiAgICBpZiAoaW5kKSB7XG4gICAgICB1c2VyPy5maWNoZURlUGFpeFROPy5zcGxpY2UoaW5kLCAxKTtcbiAgICAgIHVzZXI/LnNhdmUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoJ2ZpY2hlIGRlbGV0ZWQnKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDQpLnNlbmQoJ25vIGZpY2hlIHdpdGggaWQ6ICcgKyByZXEucGFyYW1zLmlkKTtcbiAgfVxufTtcbiJdfQ==