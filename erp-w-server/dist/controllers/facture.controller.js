"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deletefacture = exports.updatefacture = exports.getClient = exports.addfacture = exports.getAllfactures = exports.getFactureByClient = void 0;
const user_model_1 = require("../models/user.model");
const facture_model_1 = require("../models/facture.model");
const champFacture_model_1 = require("../models/champFacture.model");
const getFactureByClient = async (req, res) => {
    const cl = await user_model_1.User.findOne({ email: req.params.email });
    if (cl) {
        try {
            const factures = await facture_model_1.Facture.find({ client: cl });
            return res.send(factures);
        }
        catch (err) {
            res.send('no factures for this client');
        }
    }
    else {
        res.send('no client with such email');
    }
};
exports.getFactureByClient = getFactureByClient;
const getAllfactures = async (req, res) => {
    try {
        const factures = await facture_model_1.Facture.find().sort('date').exec();
        return res.send(factures);
    }
    catch (err) {
        res.send('no factures yet');
    }
};
exports.getAllfactures = getAllfactures;
const addfacture = async (req, res) => {
    var _a;
    const cl = await user_model_1.User.findOne({ email: req.body.email });
    const factures = await facture_model_1.Facture.find().sort('date').exec();
    let exist = false;
    const d = new Date(req.body.date);
    if (cl) {
        factures.forEach(function (fact) {
            if (fact.total == req.body.total &&
                String(fact.date) == String(new Date(req.body.date)) &&
                String(fact.client) == String(cl._id) &&
                String(fact.echeance) == String(new Date(req.body.echeance))) {
                exist = true;
            }
        });
        const date = new Date(req.body.date);
        const total = Number(req.body.total);
        const client = cl;
        const echeance = new Date(req.body.echeance);
        const champFacture = [];
        if (!exist) {
            const facture = new facture_model_1.Facture({
                date: date,
                total: total,
                client: client,
                echeance: echeance,
                champFacture: champFacture
            });
            facture.populate('client');
            try {
                const savedFacture = await facture.save();
                (_a = cl.factures) === null || _a === void 0 ? void 0 : _a.push(savedFacture);
                cl.save();
                res.send(savedFacture);
            }
            catch (err) {
                res.status(400).send('il y a une erreur');
            }
        }
        else {
            res.status(400).send('facture déjà existante');
        }
    }
    else {
        res.status(400).send('pas de client avec cette adresse email');
    }
};
exports.addfacture = addfacture;
const getClient = async (req, res) => {
    const foundFacture = await facture_model_1.Facture.find({ _id: req.params.id }).populate('client');
    res.json(foundFacture[0].client);
};
exports.getClient = getClient;
const updatefacture = async (req, res) => {
    var _a;
    const facture = await facture_model_1.Facture.findOne({ _id: req.params.id });
    if (facture) {
        const Client = await user_model_1.User.findOne({ _id: facture.client._id });
        facture_model_1.Facture.updateOne({ _id: facture._id }, {
            date: new Date(req.body.date),
            total: req.body.total,
            echeance: new Date(req.body.echeance),
        }, function (err, data) {
            if (err) {
                return res.status(400).send('erreur');
            }
            else {
                return res.status(200).send('facture updated successfully');
            }
        });
        try {
            await facture.save();
            if (Client === null || Client === void 0 ? void 0 : Client.factures) {
                const index = Client === null || Client === void 0 ? void 0 : Client.factures.indexOf(facture._id);
                if (index) {
                    if (!(Client === null || Client === void 0 ? void 0 : Client.factures[index])) {
                        await ((_a = Client === null || Client === void 0 ? void 0 : Client.factures) === null || _a === void 0 ? void 0 : _a.push(facture));
                        await (Client === null || Client === void 0 ? void 0 : Client.save());
                    }
                }
            }
        }
        catch (err) {
            res.status(400);
        }
    }
    else {
        return res.status(400).send('email introuvable');
    }
};
exports.updatefacture = updatefacture;
const deletefacture = async (req, res) => {
    var _a, _b;
    const facture = await facture_model_1.Facture.findOne({ _id: req.params.id });
    if (facture) {
        await facture_model_1.Facture.deleteOne({ _id: facture._id });
        if (facture.champFacture) {
            facture.champFacture.forEach(async (champ) => {
                await champFacture_model_1.Champ.deleteOne({ _id: champ });
            });
        }
        const user = await user_model_1.User.findOne({ _id: facture.client._id });
        const ind = (_a = user === null || user === void 0 ? void 0 : user.factures) === null || _a === void 0 ? void 0 : _a.indexOf(facture._id);
        if (ind) {
            (_b = user === null || user === void 0 ? void 0 : user.factures) === null || _b === void 0 ? void 0 : _b.splice(ind, 1);
            user === null || user === void 0 ? void 0 : user.save();
        }
        return res.status(200).send('facture deleted');
    }
    else {
        return res.status(404).send('no facture with id: ' + req.params.id);
    }
};
exports.deletefacture = deletefacture;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdHVyZS5jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsiY29udHJvbGxlcnMvZmFjdHVyZS5jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUE0QztBQUM1QywyREFBa0Q7QUFDbEQscUVBQXFEO0FBRzlDLE1BQU0sa0JBQWtCLEdBQUcsS0FBSyxFQUFFLEdBQUcsRUFBQyxHQUFHLEVBQUUsRUFBRTtJQUNsRCxNQUFNLEVBQUUsR0FBQyxNQUFNLGlCQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUNyRCxJQUFHLEVBQUUsRUFBRTtRQUNULElBQUk7WUFDRixNQUFNLFFBQVEsR0FBRyxNQUFNLHVCQUFPLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLEVBQUUsRUFBQyxDQUFDLENBQUM7WUFDbEQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzNCO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixHQUFHLENBQUMsSUFBSSxDQUFDLDZCQUE2QixDQUFDLENBQUM7U0FDekM7S0FBQztTQUFNO1FBQUssR0FBRyxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQ3BEO0FBRUQsQ0FBQyxDQUFBO0FBWFksUUFBQSxrQkFBa0Isc0JBVzlCO0FBRU0sTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUMvQyxJQUFJO1FBQ0YsTUFBTSxRQUFRLEdBQUcsTUFBTSx1QkFBTyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDM0I7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNa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QUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ3JFO0FBQ0gsQ0FBQyxDQUFDO0FBcEJXLFFBQUEsYUFBYSxpQkFvQnhCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL21vZGVscy91c2VyLm1vZGVsJztcbmltcG9ydCB7IEZhY3R1cmUgfSBmcm9tICcuLi9tb2RlbHMvZmFjdHVyZS5tb2RlbCc7XG5pbXBvcnQgeyBDaGFtcCB9IGZyb20gJy4uL21vZGVscy9jaGFtcEZhY3R1cmUubW9kZWwnO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuXG5leHBvcnQgY29uc3QgZ2V0RmFjdHVyZUJ5Q2xpZW50ID0gYXN5bmMgKHJlcSxyZXMpID0+IHtcbiAgY29uc3QgY2w9YXdhaXQgVXNlci5maW5kT25lKHtlbWFpbDogcmVxLnBhcmFtcy5lbWFpbH0pO1xuICAgIGlmKGNsKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgZmFjdHVyZXMgPSBhd2FpdCBGYWN0dXJlLmZpbmQoe2NsaWVudDogY2x9KTtcbiAgICByZXR1cm4gcmVzLnNlbmQoZmFjdHVyZXMpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXMuc2VuZCgnbm8gZmFjdHVyZXMgZm9yIHRoaXMgY2xpZW50Jyk7XG4gIH19IGVsc2UgeyAgICByZXMuc2VuZCgnbm8gY2xpZW50IHdpdGggc3VjaCBlbWFpbCcpO1xufVxuICBcbn1cblxuZXhwb3J0IGNvbnN0IGdldEFsbGZhY3R1cmVzID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgZmFjdHVyZXMgPSBhd2FpdCBGYWN0dXJlLmZpbmQoKS5zb3J0KCdkYXRlJykuZXhlYygpO1xuICAgIHJldHVybiByZXMuc2VuZChmYWN0dXJlcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHJlcy5zZW5kKCdubyBmYWN0dXJlcyB5ZXQnKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGFkZGZhY3R1cmUgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gIGNvbnN0IGNsID0gYXdhaXQgVXNlci5maW5kT25lKHsgZW1haWw6IHJlcS5ib2R5LmVtYWlsIH0pO1xuICBjb25zdCBmYWN0dXJlcyA9IGF3YWl0IEZhY3R1cmUuZmluZCgpLnNvcnQoJ2RhdGUnKS5leGVjKCk7XG4gIGxldCBleGlzdCA9IGZhbHNlO1xuICBjb25zdCBkID0gbmV3IERhdGUocmVxLmJvZHkuZGF0ZSk7XG4gIGlmIChjbCkge1xuICAgIGZhY3R1cmVzLmZvckVhY2goZnVuY3Rpb24gKGZhY3QpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZmFjdC50b3RhbCA9PSByZXEuYm9keS50b3RhbCAmJlxuICAgICAgICBTdHJpbmcoZmFjdC5kYXRlKSA9PSBTdHJpbmcobmV3IERhdGUocmVxLmJvZHkuZGF0ZSkpICYmXG4gICAgICAgIFN0cmluZyhmYWN0LmNsaWVudCkgPT0gU3RyaW5nKGNsLl9pZCkgJiZcbiAgICAgICAgU3RyaW5nKGZhY3QuZWNoZWFuY2UpID09IFN0cmluZyhuZXcgRGF0ZShyZXEuYm9keS5lY2hlYW5jZSkpXG4gICAgICApIHtcbiAgICAgICAgZXhpc3QgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShyZXEuYm9keS5kYXRlKTtcbiAgICBjb25zdCB0b3RhbCA9IE51bWJlcihyZXEuYm9keS50b3RhbCk7XG4gICAgY29uc3QgY2xpZW50ID0gY2w7XG4gICAgY29uc3QgZWNoZWFuY2UgPSBuZXcgRGF0ZShyZXEuYm9keS5lY2hlYW5jZSk7XG4gICAgY29uc3QgY2hhbXBGYWN0dXJlID0gW107XG4gICAgaWYgKCFleGlzdCkge1xuICAgICAgY29uc3QgZmFjdHVyZSA9IG5ldyBGYWN0dXJlKHtcbiAgICAgICAgZGF0ZTogZGF0ZSxcbiAgICAgICAgdG90YWw6IHRvdGFsLFxuICAgICAgICBjbGllbnQ6IGNsaWVudCxcbiAgICAgICAgZWNoZWFuY2U6IGVjaGVhbmNlLFxuICAgICAgICBjaGFtcEZhY3R1cmUgOiAgY2hhbXBGYWN0dXJlXG4gICAgICB9KVxuICAgICAgZmFjdHVyZS5wb3B1bGF0ZSgnY2xpZW50Jyk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzYXZlZEZhY3R1cmUgPSBhd2FpdCBmYWN0dXJlLnNhdmUoKTtcbiAgICAgICAgY2wuZmFjdHVyZXM/LnB1c2goc2F2ZWRGYWN0dXJlKTtcbiAgICAgICAgY2wuc2F2ZSgpO1xuICAgICAgICByZXMuc2VuZChzYXZlZEZhY3R1cmUpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdpbCB5IGEgdW5lIGVycmV1cicpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCkuc2VuZCgnZmFjdHVyZSBkw6lqw6AgZXhpc3RhbnRlJyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdwYXMgZGUgY2xpZW50IGF2ZWMgY2V0dGUgYWRyZXNzZSBlbWFpbCcpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0Q2xpZW50ID0gYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IGZvdW5kRmFjdHVyZSA9IGF3YWl0IEZhY3R1cmUuZmluZCh7IF9pZDogcmVxLnBhcmFtcy5pZCB9KS5wb3B1bGF0ZSgnY2xpZW50Jyk7XG4gIHJlcy5qc29uKGZvdW5kRmFjdHVyZVswXS5jbGllbnQpO1xufTtcblxuLy91cGRhdGUgZmFjdHVyZVxuZXhwb3J0IGNvbnN0IHVwZGF0ZWZhY3R1cmUgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgZmFjdHVyZSA9IGF3YWl0IEZhY3R1cmUuZmluZE9uZSh7IF9pZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgaWYgKGZhY3R1cmUpIHtcbiAgICBjb25zdCBDbGllbnQgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyBfaWQ6IGZhY3R1cmUuY2xpZW50Ll9pZCB9KTtcbiAgICBGYWN0dXJlLnVwZGF0ZU9uZShcbiAgICAgIHsgX2lkOiBmYWN0dXJlLl9pZCB9LFxuICAgICAge1xuICAgICAgICBkYXRlOiBuZXcgRGF0ZShyZXEuYm9keS5kYXRlKSxcbiAgICAgICAgdG90YWw6IHJlcS5ib2R5LnRvdGFsLFxuICAgICAgICBlY2hlYW5jZTogbmV3IERhdGUocmVxLmJvZHkuZWNoZWFuY2UpLFxuICAgICAgfSxcbiAgICAgIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnZXJyZXVyJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCdmYWN0dXJlIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKTtcbiAgICAvKmlmICh1c2VyICYmIHJlcS5ib2R5LmVtYWlsICE9IHVzZXIuZW1haWwpIHtcbiAgICAgIGNvbnN0IGluZCA9IHVzZXIuZmFjdHVyZXM/LmluZGV4T2YoZmFjdHVyZS5pZCk7XG4gICAgICBpZiAoaW5kKSB7XG4gICAgICAgIGF3YWl0IHVzZXIuZmFjdHVyZXM/LnNwbGljZShpbmQsIDEpO1xuICAgICAgICBhd2FpdCB1c2VyPy5zYXZlKCk7XG4gICAgICB9XG4gICAgfSovXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZhY3R1cmUuc2F2ZSgpO1xuICAgICAgaWYgKENsaWVudD8uZmFjdHVyZXMpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSBDbGllbnQ/LmZhY3R1cmVzLmluZGV4T2YoZmFjdHVyZS5faWQpO1xuICAgICAgICBpZiAoaW5kZXgpIHtcbiAgICAgICAgICBpZiAoIUNsaWVudD8uZmFjdHVyZXNbaW5kZXhdKSB7XG4gICAgICAgICAgICBhd2FpdCBDbGllbnQ/LmZhY3R1cmVzPy5wdXNoKGZhY3R1cmUpO1xuICAgICAgICAgICAgYXdhaXQgQ2xpZW50Py5zYXZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvL3Jlcy5zZW5kKHNhdmVkZmFjdHVyZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXMuc3RhdHVzKDQwMCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnZW1haWwgaW50cm91dmFibGUnKTtcbiAgfVxufTtcblxuLy9kZWxldGUgZmFjdHVyZVxuZXhwb3J0IGNvbnN0IGRlbGV0ZWZhY3R1cmUgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgZmFjdHVyZSA9IGF3YWl0IEZhY3R1cmUuZmluZE9uZSh7IF9pZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgaWYgKGZhY3R1cmUpIHtcbiAgICBhd2FpdCBGYWN0dXJlLmRlbGV0ZU9uZSh7IF9pZDogZmFjdHVyZS5faWQgfSk7XG4gICAgaWYgKGZhY3R1cmUuY2hhbXBGYWN0dXJlKSB7XG4gICAgICBmYWN0dXJlLmNoYW1wRmFjdHVyZS5mb3JFYWNoKGFzeW5jIChjaGFtcCkgPT4ge1xuICAgICAgICBhd2FpdCBDaGFtcC5kZWxldGVPbmUoeyBfaWQ6IGNoYW1wIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRPbmUoeyBfaWQ6IGZhY3R1cmUuY2xpZW50Ll9pZCB9KTtcbiAgICBjb25zdCBpbmQgPSB1c2VyPy5mYWN0dXJlcz8uaW5kZXhPZihmYWN0dXJlLl9pZCk7XG4gICAgaWYgKGluZCkge1xuICAgICAgdXNlcj8uZmFjdHVyZXM/LnNwbGljZShpbmQsIDEpO1xuICAgICAgdXNlcj8uc2F2ZSgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCgnZmFjdHVyZSBkZWxldGVkJyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA0KS5zZW5kKCdubyBmYWN0dXJlIHdpdGggaWQ6ICcgKyByZXEucGFyYW1zLmlkKTtcbiAgfVxufTtcbiJdfQ==