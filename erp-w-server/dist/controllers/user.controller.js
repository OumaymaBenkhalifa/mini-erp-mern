"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deleteUser = exports.updateUser = exports.addUser = exports.getAllFactures = exports.getUserByEmail = exports.getAllUsers = void 0;
const user_model_1 = require("../models/user.model");
const facture_model_1 = require("../models/facture.model");
const getAllUsers = async (req, res) => {
    const user = await user_model_1.User.find().sort('date').exec();
    return res.send(user);
};
exports.getAllUsers = getAllUsers;
const getUserByEmail = async (req, res) => {
    const user = await user_model_1.User.findOne({ email: req.params.email });
    if (user) {
        return res.status(200).send(user);
    }
    else {
        return res.status(400).send('no user with email:' + req.params.email);
    }
};
exports.getUserByEmail = getUserByEmail;
const getAllFactures = async (req, res) => {
    const foundUser = await user_model_1.User.find({ _id: req.params._id }).populate('factures').exec();
    res.json(foundUser[0].factures);
};
exports.getAllFactures = getAllFactures;
const addUser = async (req, res) => {
    const currentUser = await user_model_1.User.findOne({ email: req.body.email });
    if (currentUser)
        return res.status(400).send('Email already exists');
    const user = new user_model_1.User(req.body);
    if (user.role == "employe" || user.role == "client") {
        try {
            const savedUser = await user.save();
            res.send(savedUser);
        }
        catch (err) {
            res.status(400);
        }
    }
};
exports.addUser = addUser;
const updateUser = async (req, res) => {
    const user = await user_model_1.User.findOne({ email: req.params.email });
    if (user) {
        if (user.role == "employe" || user.role == "client") {
            user_model_1.User.updateOne({ _id: user._id }, { nom: req.body.nom, prenom: req.body.prenom, password: req.body.password }, function (err, data) {
                if (err) {
                    return res.status(400).send('erreur');
                }
                else {
                    return res.status(200).send('user updated successfully');
                }
            });
            try {
                await user.save();
            }
            catch (err) {
                res.status(400);
            }
        }
    }
    else {
        return res.status(400).send('email introuvable');
    }
};
exports.updateUser = updateUser;
const deleteUser = async (req, res) => {
    const user = await user_model_1.User.findOne({ email: req.params.email });
    if (user) {
        if (user.role == "employe" || user.role == "client") {
            await user_model_1.User.deleteOne({ email: user.email });
            if (user.factures) {
                user.factures.forEach(async (facture) => {
                    await facture_model_1.Facture.deleteOne({ _id: facture });
                });
            }
            return res.status(200).send('user deleted');
        }
    }
    else {
        return res.status(404).send('no user with email: ' + req.params.email);
    }
};
exports.deleteUser = deleteUser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsiY29udHJvbGxlcnMvdXNlci5jb250cm9sbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUF3RDtBQUN4RCwyREFBa0Q7QUFHM0MsTUFBTSxXQUFXLEdBQUcsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUM1QyxNQUFNLElBQUksR0FBRyxNQUFNLGlCQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25ELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4QixDQUFDLENBQUM7QUFIVyxRQUFBLFdBQVcsZUFHdEI7QUFFSyxNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQy9DLE1BQU0sSUFBSSxHQUFHLE1BQU0saUJBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzdELElBQUksSUFBSSxFQUFFO1FBQ1IsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNuQztTQUFNO1FBQ0wsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3ZFO0FBQ0gsQ0FBQyxDQUFDO0FBUFcsUUFBQSxjQUFjLGtCQU96QjtBQUNLLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDL0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxpQkFBSSxDQUFDLElBQUksQ0FBQyxFQUFF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Q0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzdELElBQUksSUFBSSxFQUFFO1FBQ1IsSUFBRyxJQUFJLENBQUMsSUFBSSxJQUFJLFNBQVMsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFFLFFBQVEsRUFBRTtZQUNsRCxNQUFNLGlCQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQzVDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO29CQUN0QyxNQUFNLHVCQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBQzVDLENBQUMsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQzdDO0tBQ0E7U0FBTTtRQUNMLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUN4RTtBQUNILENBQUMsQ0FBQztBQWZXLFFBQUEsVUFBVSxjQWVyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFVzZXIsIFVzZXJTY2hlbWEgfSBmcm9tICcuLi9tb2RlbHMvdXNlci5tb2RlbCc7XG5pbXBvcnQgeyBGYWN0dXJlIH0gZnJvbSAnLi4vbW9kZWxzL2ZhY3R1cmUubW9kZWwnO1xuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuXG5leHBvcnQgY29uc3QgZ2V0QWxsVXNlcnMgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZCgpLnNvcnQoJ2RhdGUnKS5leGVjKCk7XG4gIHJldHVybiByZXMuc2VuZCh1c2VyKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRVc2VyQnlFbWFpbCA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT25lKHsgZW1haWw6IHJlcS5wYXJhbXMuZW1haWwgfSk7XG4gIGlmICh1c2VyKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHVzZXIpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnbm8gdXNlciB3aXRoIGVtYWlsOicgKyByZXEucGFyYW1zLmVtYWlsKTtcbiAgfVxufTtcbmV4cG9ydCBjb25zdCBnZXRBbGxGYWN0dXJlcyA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBmb3VuZFVzZXIgPSBhd2FpdCBVc2VyLmZpbmQoeyBfaWQ6IHJlcS5wYXJhbXMuX2lkIH0pLnBvcHVsYXRlKCdmYWN0dXJlcycpLmV4ZWMoKTtcbiAgcmVzLmpzb24oZm91bmRVc2VyWzBdLmZhY3R1cmVzKTtcbn07XG5cbmV4cG9ydCBjb25zdCBhZGRVc2VyID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAvL2NoZWNrIGlmIGVtYWlsIGV4aXN0c1xuICBjb25zdCBjdXJyZW50VXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiByZXEuYm9keS5lbWFpbCB9KTtcbiAgaWYgKGN1cnJlbnRVc2VyKSByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoJ0VtYWlsIGFscmVhZHkgZXhpc3RzJyk7XG5cbiAgY29uc3QgdXNlciA9IG5ldyBVc2VyKHJlcS5ib2R5KTtcblxuICAvKmNvbnN0IHVzZXIgPSBuZXcgVXNlcih7XG4gICAgbm9tOiByZXEuYm9keS5ub20sXG4gICAgcHJlbm9tOiByZXEuYm9keS5wcmVub20sXG4gICAgcm9sZTogcmVxLmJvZHkucm9sZSxcbiAgICBlbWFpbDogcmVxLmJvZHkuZW1haWwsXG4gICAgcGFzc3dvcmQ6IHJlcS5ib2R5LnBhc3N3b3JkLFxuICAgIGZhY3R1cmVzOiBBcnJheSgpLFxuICB9KTsqL1xuICBpZih1c2VyLnJvbGUgPT0gXCJlbXBsb3llXCIgfHwgdXNlci5yb2xlPT1cImNsaWVudFwiKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc2F2ZWRVc2VyID0gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgcmVzLnNlbmQoc2F2ZWRVc2VyKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmVzLnN0YXR1cyg0MDApO1xuICB9fVxufTtcblxuZXhwb3J0IGNvbnN0IHVwZGF0ZVVzZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiByZXEucGFyYW1zLmVtYWlsIH0pO1xuICBpZiAodXNlcikge1xuICAgIGlmKHVzZXIucm9sZSA9PSBcImVtcGxveWVcIiB8fCB1c2VyLnJvbGU9PVwiY2xpZW50XCIpIHtcbiAgICBVc2VyLnVwZGF0ZU9uZShcbiAgICAgIHsgX2lkOiB1c2VyLl9pZCB9LFxuICAgICAgeyBub206IHJlcS5ib2R5Lm5vbSwgcHJlbm9tOiByZXEuYm9keS5wcmVub20sIHBhc3N3b3JkOiByZXEuYm9keS5wYXNzd29yZCB9LFxuICAgICAgZnVuY3Rpb24gKGVyciwgZGF0YSkge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKCdlcnJldXInKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoJ3VzZXIgdXBkYXRlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgLy8gcmVzLnNlbmQoc2F2ZWRVc2VyKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAwKTtcbiAgICB9fVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgnZW1haWwgaW50cm91dmFibGUnKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGRlbGV0ZVVzZXIgPSBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiByZXEucGFyYW1zLmVtYWlsIH0pO1xuICBpZiAodXNlcikge1xuICAgIGlmKHVzZXIucm9sZSA9PSBcImVtcGxveWVcIiB8fCB1c2VyLnJvbGU9PVwiY2xpZW50XCIpIHtcbiAgICBhd2FpdCBVc2VyLmRlbGV0ZU9uZSh7IGVtYWlsOiB1c2VyLmVtYWlsIH0pO1xuICAgIGlmICh1c2VyLmZhY3R1cmVzKSB7XG4gICAgICB1c2VyLmZhY3R1cmVzLmZvckVhY2goYXN5bmMgKGZhY3R1cmUpID0+IHtcbiAgICAgICAgYXdhaXQgRmFjdHVyZS5kZWxldGVPbmUoeyBfaWQ6IGZhY3R1cmUgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5zZW5kKCd1c2VyIGRlbGV0ZWQnKTtcbiAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuc2VuZCgnbm8gdXNlciB3aXRoIGVtYWlsOiAnICsgcmVxLnBhcmFtcy5lbWFpbCk7XG4gIH1cbn07XG4iXX0=